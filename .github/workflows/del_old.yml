name: Delete old oi_data CSV files

on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Cleanup old files
      shell: bash
      run: |
        today=$(date +%s)

        for f in oi_data_*.csv; do
          [ -f "$f" ] || continue

          datepart=${f#oi_data_}
          datepart=${datepart%.csv}

          # extract DD MM YYYY
          IFS='-' read -r dd mm yy <<< "$datepart"

          # reformat to YYYY-MM-DD
          iso_date="${yy}-${mm}-${dd}"

          # get epoch
          file_epoch=$(date -d "$iso_date" +%s 2>/dev/null)

          if [[ -z "$file_epoch" ]]; then
            echo "âš  Cannot parse date: $f"
            continue
          fi

          # skip future
          if (( file_epoch > today )); then
            echo "â­ FUTURE DATE SKIP: $f"
            continue
          fi

          age=$(( (today - file_epoch) / 86400 ))

          echo "$f age = $age days"

          if (( age > 30 )); then
            echo "ðŸ—‘ DELETE: $f"
            git rm "$f"
          else
            echo "âœ” KEEP: $f"
          fi
        done

        git config user.email "actions@github.com"
        git config user.name "github-actions"

        if git diff --cached --quiet; then
          echo "No files deleted."
        else
          git commit -m "Auto clean old oi_data files"
          git push
        fi
