name: Delete old OI CSV files

on:
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (FULL)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show files
        run: |
          echo "Existing CSV files:"
          find . -type f -name "oi_data*.csv"

      - name: Delete CSV older than 30 days (filename or mtime)
        run: |
          echo "Deleting old oi_data CSV files..."
          
          cutoff=$(date -d "30 days ago" +%s)
          
          for file in $(find . -type f -name "oi_data*.csv"); do
            fname=$(basename "$file")

            # Extract date if present: DD-MM-YYYY
            datepart=$(echo "$fname" | grep -oP '\d{2}-\d{2}-\d{4}')

            if [ -n "$datepart" ]; then
              # Convert date from filename to epoch
              file_epoch=$(date -d "$datepart" +%s || echo 0)

              if [ "$file_epoch" -le "$cutoff" ]; then
                echo "DELETE by filename date: $fname ($datepart)"
                rm "$file"
              else
                echo "KEEP by filename date: $fname ($datepart)"
              fi
            else
              # No date in filename â†’ use mtime
              mtime_epoch=$(stat -c %Y "$file")

              if [ "$mtime_epoch" -le "$cutoff" ]; then
                echo "DELETE by mtime: $fname (no date in filename)"
                rm "$file"
              else
                echo "KEEP by mtime: $fname (no date in filename)"
              fi
            fi
          done

      - name: Commit & push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "Auto delete old OI CSV files"
            git push
            echo "Old files deleted and pushed."
          else
            echo "No old files to delete."
          fi
